import { ListStateStorage } from '@sentio/runtime';
import { isInterfaceType, isObjectType, isScalarType, parse } from 'graphql/index.js';
import { buildSchema } from '../store/schema.js';
export class DatabaseSchemaState extends ListStateStorage {
    static INSTANCE = new DatabaseSchemaState();
}
export class DatabaseSchema {
    static register(schema) {
        DatabaseSchemaState.INSTANCE.addValue(schema);
    }
    static findEntity(name) {
        for (const schema of DatabaseSchemaState.INSTANCE.getValues()) {
            if (schema.entities[name]) {
                return schema.entities[name];
            }
        }
        return undefined;
    }
}
export function mergeSchemas(schemas) {
    const allTypes = {};
    let ret = '';
    for (const schema of schemas) {
        let source = schema.source;
        const gqlSchema = buildSchema(parse(source));
        for (const type of Object.values(gqlSchema.getTypeMap())) {
            if (isScalarType(type) || type.name.startsWith('__')) {
                // types.push(type)
                continue;
            }
            if (allTypes[type.name]) {
                console.warn(`Type ${type.name} is already registered, you have duplicate definitions in multiple schemas.`);
                // remove the definition from source using regex
                if (isObjectType(type)) {
                    const p = `type\\s+${type.name}\\s+[^}]+\\}`;
                    source = source.replace(new RegExp(p, 'g'), '');
                }
                else if (isInterfaceType(type)) {
                    source = source.replace(new RegExp(`interface\s+${type.name}\s+[^}]+\}`, 'g'), '');
                }
            }
            else {
                allTypes[type.name] = type;
            }
        }
        ret += source + '\n';
    }
    return ret;
}
//# sourceMappingURL=database-schema.js.map